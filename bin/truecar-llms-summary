#!/bin/bash

# TrueCar LLMs.txt Generator Script
# This script generates llms.txt from urls/llms_urls.yaml
# Usage: ./bin/truecar-llms-summary [--resume] [--force-fresh]

set -e  # Exit on any error

# Parse command line arguments
RESUME_MODE=false
FORCE_FRESH=false
for arg in "$@"; do
    case $arg in
        --resume)
            RESUME_MODE=true
            ;;
        --force-fresh)
            FORCE_FRESH=true
            ;;
        --help|-h)
            echo "Usage: $0 [--resume] [--force-fresh]"
            echo ""
            echo "Options:"
            echo "  --resume       Resume from where you left off (auto-detected if not specified)"
            echo "  --force-fresh  Force a fresh start, ignoring existing progress"
            echo "  --help, -h     Show this help message"
            exit 0
            ;;
    esac
done

# Create output directory
mkdir -p out

# Auto-detect if resume is needed (unless force-fresh is specified)
# Note: Resume mode is disabled for YAML files with sections due to grouped format complexity
if [ "$FORCE_FRESH" = false ] && [ -f "./out/truecar.com-llms.txt" ]; then
    # Check if the existing file is in grouped format (has section headers)
    if grep -q "^## " ./out/truecar.com-llms.txt; then
        echo "ğŸ”„ Detected grouped format in existing file"
        echo "ğŸ“‹ Resume mode is not supported with grouped format"
        echo "ğŸ†• Starting fresh to regenerate grouped output..."
        RESUME_MODE=false
    else
        # Original resume logic for flat format
        CURRENT_COUNT=$(grep -c "^\- \[" ./out/truecar.com-llms.txt || echo "0")
        TOTAL_COUNT=$(grep -c "  - https://" urls/llms_urls.yaml || echo "0")
        
        if [ $CURRENT_COUNT -gt 0 ] && [ $CURRENT_COUNT -lt $TOTAL_COUNT ]; then
            echo "ğŸ”„ Resume Mode: Continuing from where you left off..."
            echo "=================================================="
            echo "ğŸ“Š Current Progress:"
            echo "   âœ… Processed: $CURRENT_COUNT URLs"
            echo "   ğŸ“‹ Total: $TOTAL_COUNT URLs"
            echo "   ğŸ”„ Remaining: $((TOTAL_COUNT - CURRENT_COUNT)) URLs"
            echo ""
            
            # Ask user if they want to resume
            read -p "ğŸš€ Do you want to resume processing? (Y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Nn]$ ]]; then
                echo "ğŸ†• Starting fresh instead..."
                RESUME_MODE=false
            else
                RESUME_MODE=true
            fi
        elif [ $CURRENT_COUNT -eq $TOTAL_COUNT ]; then
            echo "ğŸ‰ All URLs have already been processed!"
            echo "ğŸ“Š Final Progress: $CURRENT_COUNT/$TOTAL_COUNT URLs completed"
            echo "ğŸ’¡ Use --force-fresh to start over"
            exit 0
        else
            echo "ğŸ†• Fresh Start: Processing all URLs..."
            echo "====================================="
            RESUME_MODE=false
        fi
    fi
elif [ "$RESUME_MODE" = true ]; then
    echo "ğŸ”„ Resume Mode: Continuing from where you left off..."
    echo "=================================================="
    
    # Check if we have existing files
    if [ ! -f "./out/truecar.com-llms.txt" ]; then
        echo "âŒ No existing llms.txt file found in ./out/"
        echo "ğŸ’¡ Starting fresh instead..."
        RESUME_MODE=false
    else
        # Count current progress
        CURRENT_COUNT=$(grep -c "^\- \[" ./out/truecar.com-llms.txt || echo "0")
        TOTAL_COUNT=$(grep -c "  - https://" urls/llms_urls.yaml || echo "0")
        
        echo "ğŸ“Š Current Progress:"
        echo "   âœ… Processed: $CURRENT_COUNT URLs"
        echo "   ğŸ“‹ Total: $TOTAL_COUNT URLs"
        echo "   ğŸ”„ Remaining: $((TOTAL_COUNT - CURRENT_COUNT)) URLs"
        
        if [ $CURRENT_COUNT -eq $TOTAL_COUNT ]; then
            echo "ğŸ‰ All URLs have already been processed!"
            exit 0
        fi
    fi
else
    echo "ğŸ†• Fresh Start: Processing all URLs..."
    echo "====================================="
fi

if [ "$RESUME_MODE" = true ]; then
    # Create resume file with remaining URLs
    echo "ğŸ“ Creating resume file..."
    python resume_llmstxt.py \
      --input-file urls/llms_urls.yaml \
      --llmstxt-file ./out/truecar.com-llms.txt \
      --output-file urls/llms_urls_resume.yaml
    
    # Use resume file
    URL_FILE="urls/llms_urls_resume.yaml"
    MAX_URLS=$((TOTAL_COUNT - CURRENT_COUNT))
else
    URL_FILE="urls/llms_urls.yaml"
    MAX_URLS=""
fi

# Run with appropriate file pattern
echo "ğŸ“‹ Generating llms.txt from $URL_FILE..."
if [ -n "$MAX_URLS" ]; then
    python generate-llmstxt.py https://www.truecar.com \
      --file-pattern "$URL_FILE" \
      --output-dir ./out \
      --no-full-text \
      --max-urls "$MAX_URLS" \
      --verbose
else
    python generate-llmstxt.py https://www.truecar.com \
      --file-pattern "$URL_FILE" \
      --output-dir ./out \
      --no-full-text \
      --verbose
fi

echo "âœ… llms.txt generation completed!"
echo "ğŸ“ Output file saved to: ./out/truecar.com-llms.txt"

# Clean up resume file if it was created
if [ -f "urls/llms_urls_resume.yaml" ]; then
    rm urls/llms_urls_resume.yaml
    echo "ğŸ§¹ Cleaned up temporary resume file"
fi
